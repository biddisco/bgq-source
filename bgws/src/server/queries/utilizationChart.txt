-- UTILIZATION_CHART

WITH

dt( t0, day0, t1, day1, t2, day2, t3, day3, t4, day4, seconds4 ) AS (
  VALUES (
    DOUBLE(0.0),
    CURRENT_DATE - 4 DAYS,
    DOUBLE(0.0),
    CURRENT_DATE - 3 DAYS,
    DOUBLE(0.0),
    CURRENT_DATE - 2 DAYS,
    DOUBLE(0.0),
    CURRENT_DATE - 1 DAYS,
    DOUBLE(0.0),
    CURRENT_DATE - 0 DAYS,
    DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR( CURRENT_TIMESTAMP - TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) ) )
  )
),

js AS (

SELECT startTime, CURRENT_TIMESTAMP AS endTime, nodesUsed
  FROM bgqJob
UNION ALL
SELECT startTime, entryDate AS endTime, nodesUsed
  FROM bgqJob_history
  WHERE entryDate >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 4 DAY), TIME(DATE(CURRENT_TIMESTAMP)) )

),

ts AS (

SELECT
   SUM( CASE WHEN endTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 4 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) AND startTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN
     DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR(
         CASE WHEN endTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN endTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END -
         CASE WHEN startTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 4 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN startTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 4 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END
       ) ) * (CASE WHEN nodesUsed = 0 THEN (DOUBLE(1.0) / 64.0) ELSE (1.0 * nodesUsed) END)
    ELSE
     0
    END ) AS t0,

   SUM( CASE WHEN endTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) AND startTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN
     DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR(
         CASE WHEN endTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN endTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END -
         CASE WHEN startTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN startTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 3 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END
       ) ) * (CASE WHEN nodesUsed = 0 THEN (DOUBLE(1.0) / 64.0) ELSE (1.0 * nodesUsed) END)
    ELSE
     0
    END ) AS t1,

   SUM ( CASE WHEN endTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) AND startTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN
     DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR(
         CASE WHEN endTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN endTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END -
         CASE WHEN startTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN startTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 2 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END
       ) ) * (CASE WHEN nodesUsed = 0 THEN (DOUBLE(1.0) / 64.0) ELSE (1.0 * nodesUsed) END)
    ELSE
     0
    END ) AS t2,

   SUM( CASE WHEN endTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) AND startTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN
     DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR(
         CASE WHEN endTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN endTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END -
         CASE WHEN startTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN startTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END
       ) ) * (CASE WHEN nodesUsed = 0 THEN (DOUBLE(1.0) / 64.0) ELSE (1.0 * nodesUsed) END)
    ELSE
     0
    END ) AS t3,

   SUM( CASE WHEN endTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) AND startTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP + 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN
     DOUBLE(1.0) * TIMESTAMPDIFF( 2, CHAR(
         CASE WHEN endTime <= TIMESTAMP( DATE(CURRENT_TIMESTAMP + 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN endTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP + 1 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END -
         CASE WHEN startTime >= TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) THEN startTime ELSE TIMESTAMP( DATE(CURRENT_TIMESTAMP - 0 DAY), TIME(DATE(CURRENT_TIMESTAMP)) ) END
       ) ) * (CASE WHEN nodesUsed = 0 THEN (DOUBLE(1.0) / 64.0) ELSE (1.0 * nodesUsed) END)
    ELSE
     0
    END ) AS t4

  FROM js

)

SELECT day0, day1, day2, day3, day4,
       COALESCE( ts.t0, dt.t0 ) AS t0, 
       COALESCE( ts.t1, dt.t1 ) AS t1, 
       COALESCE( ts.t2, dt.t2 ) AS t2, 
       COALESCE( ts.t3, dt.t3 ) AS t3, 
       COALESCE( ts.t4, dt.t4 ) AS t4, 
       seconds4
 FROM dt LEFT OUTER JOIN ts ON 1=1
